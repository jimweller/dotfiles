#!/usr/bin/env bash

set -e

CONFIG="install.common.yaml"
CONFIG_MACOS="install.macos.yaml"
CONFIG_LINUX="install.linux.yaml"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if ! command -v python3 >/dev/null 2>&1; then
  echo "Python3 not found."

  echo -n "Detecting OS..."
  OS="$(uname -s)"
  echo " $OS"

  if [ "$OS" = "Linux" ]; then
    echo "Installing Python3 using apt-get..."
    sudo apt-get update && sudo apt-get install -y python3

  elif [ "$OS" = "Darwin" ]; then
    echo "Installing Python3 using Homebrew..."
    
    # Check if Homebrew is installed
    if ! command -v brew >/dev/null 2>&1; then
      echo "Homebrew not found. Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      
      # Add Homebrew to PATH for current session
      if [[ -d "/opt/homebrew" ]]; then
        export PATH="/opt/homebrew/bin:$PATH"
      elif [[ -d "/usr/local/Homebrew" ]]; then
        export PATH="/usr/local/bin:$PATH"
      fi
      
      # Verify Homebrew installation
      if ! command -v brew >/dev/null 2>&1; then
        echo "Error: Homebrew installation failed. Please install manually."
        exit 1
      fi
      echo "Homebrew installed successfully."
    fi
    
    # Install Python3 using Homebrew
    echo "Installing Python3..."
    if ! brew install python; then
      echo "Warning: Python3 installation via Homebrew failed. You may need to install it manually."
      echo "You can try: brew install python3"
    else
      echo "Python3 installed successfully via Homebrew."
    fi

  else
    echo "Unknown OS: $OS. Cannot install Python automatically."
  fi
fi


cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"


# install the common configuration used by all OS
"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}"


# install OS specific configurations
# Detect OS and run the OS-specific profile
if [[ "$(uname)" == "Darwin" ]]; then
    echo "Running macOS-specific tasks..."
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG_MACOS}"
elif [[ "$(uname)" == "Linux" ]]; then
    echo "Running Linux-specific tasks..."
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG_LINUX}"
else
    echo "Unsupported OS: $(uname)"
fi